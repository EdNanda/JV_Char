# -*- coding: utf-8 -*-
"""
Created on Thu Aug  4 13:58:17 2022

@author: HYDN02
"""
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy.optimize import curve_fit

from lmfit import Model, Parameters, Parameter


Jfor=[-5.6907106666666665e-05, -5.6317313333333336e-05, -5.507208e-05, -5.378937e-05, -5.255678333333333e-05, -5.143197e-05, -5.0350676666666666e-05, -4.9381740000000005e-05, -4.849498333333333e-05, -4.7588480000000006e-05, -4.6974906666666666e-05, -4.647895999999999e-05, -4.582235e-05, -4.502034666666667e-05, -4.385461666666667e-05, -4.176626333333334e-05, -3.839598333333333e-05, -3.216612666666667e-05, -2.034687e-05, 3.581333666666667e-06]
Vfor=[-0.20000000000000004, -0.15000000000000002, -0.10000000000000003, -0.050000000000000044, -5.551115123125783e-17, 0.04999999999999993, 0.09999999999999992, 0.1499999999999999, 0.19999999999999987, 0.2499999999999999, 0.2999999999999999, 0.3499999999999998, 0.39999999999999986, 0.4499999999999999, 0.49999999999999983, 0.5499999999999998, 0.5999999999999999, 0.6499999999999999, 0.6999999999999997, 0.7499999999999997]
Jbkw=[5.092524333333333e-05, 4.054870666666666e-06, -1.9594776666666665e-05, -3.185421e-05, -3.8171386666666666e-05, -4.166453333333333e-05, -4.37401e-05, -4.5199633333333333e-05, -4.605421333333333e-05, -4.6876403333333335e-05, -4.754296666666667e-05, -4.817776333333333e-05, -4.8783166666666664e-05, -4.9449109999999995e-05, -5.013382e-05, -5.0830219999999995e-05, -5.1489350000000005e-05, -5.222690333333334e-05, -5.289379333333333e-05, -5.351670666666667e-05, -5.420150666666666e-05]*10**5
Vbkw=[0.8000000000000002, 0.75, 0.6999999999999998, 0.6499999999999999, 0.5999999999999999, 0.5499999999999998, 0.4999999999999998, 0.44999999999999973, 0.3999999999999997, 0.34999999999999964, 0.2999999999999996, 0.24999999999999956, 0.1999999999999995, 0.14999999999999947, 0.09999999999999942, 0.04999999999999938, -6.661338147750939e-16, -0.05000000000000071, -0.10000000000000075, -0.1500000000000008, -0.20000000000000084]



def diode_eq(x,Iq,Isc,Is,Rs,Rp):
    ## Variables
    kbu = 8.6173E-5 #Boltzmann constant in eV/K
    Temp = 300 #Temperature in K
    # Iq = -10^-12
    # Isc = -35 #Short-circuit current
    # Is = 1.5**-12 #Saturation current
    # Rs = 0 #Series resistance
    # Rp = 10**15 #Shunt resistance
    
    return Is*(np.exp((x-Iq*Rs)/(kbu*Temp))-1) + Isc + (x-Iq*Rs)/Rp -Iq

# init_vals = [-10**-12,-35,-1.5**-12,0,10**15]
# best_vals, covar = curve_fit(diode_eq, Vfor, Jfor,p0=init_vals)

gmodel = Model(diode_eq)
params = Parameters()

params["Iq"] = Parameter(name="Iq", value=-2.23E-13,vary=False, min=-1E-13, max=-5E-13)
params["Isc"] = Parameter(name="Isc", value=-5.207,vary=False)#, min=-30, max=0)
params["Is"] = Parameter(name="Is", value=2.23E-13, vary=True,min=1E-13, max=5E-13)
params["Rs"] = Parameter(name="Rs", value=1E11, vary=False, min=1E10, max=2E11)
params["Rp"] = Parameter(name="Rp", value=0.6, vary=False, min=0.5, max=0.6)

result = gmodel.fit(Jfor,params, x=Vfor)

# result = gmodel.fit(Jfor, x=Vfor,Iq=-10**-12,Isc=-6,Is=-1.5**-21,Rs=0.1,Rp=10**3)

print(result.fit_report())

plt.plot(Vfor,np.array(Jfor)*10**5,"xb-")
# plt.plot(Vbkw,Jbkw,".r--")
plt.plot(Vfor,result.best_fit,"g--")
plt.ylim((-8,2))
plt.show()